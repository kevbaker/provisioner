#! /bin/bash

## Deployment User

# Add a deployment user
# * use the /bin/bash shell instead of /bin/sh
# * create home dir in /home/deployer
# * set the password for the user
useradd -s /bin/bash -m --password="$(openssl passwd qwerty)" deployer

# Add user to RVM if it exists, doing it in a separate command
# otherwise the user won't be added if the group does not exist
usermod -G rvm deployer

# Add the deployment user to sudoers enabling the deployment user to perform
# commands via sudo without providing the root password. Skip this if the user
# is already listed
if [[ $(cat /etc/sudoers) != *deployer* ]]; then
  sed -i "/root.*ALL=(ALL) ALL/ a\deployer ALL\=\(ALL\) NOPASSWD\: ALL" /etc/sudoers
fi

# Add a .gemrc to the deployment user
curl https://github.com/meskyanichi/provisioner/raw/master/lib/rvm/gemrc > /home/deployer/.gemrc

# create the deployment directory and apply
# the correct permissions for the deployment user
mkdir -p /var/applications
chown -R deployer:www-data /var/applications